<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
	<title>Document</title>
	<style>
		#score{
			position: absolute;
			top: 500px;
		}
	</style>
</head>
<body>
	<div id="legend"></div>
	<div id="score"></div>
</body>
<script src='lufylegend.js-lufylegend-1.10.1/lufylegend-1.10.1.js'></script>
<script>
	var imgData = [//要使用到的素材
		{name:'back',path:'images/back.jpg'},
		{name:'player',path:'images/player.png'},
		{name:'fruit1', path:'images/item0.png'},
		{name:'fruit2', path:'images/item1.png'},
		{name:'fruit3', path:'images/item2.png'},
		{name:'fruit4', path:'images/item3.png'},
		{name:'fruit5', path:'images/item4.png'},
		{name:'fruit6', path:'images/item5.png'},
		{name:'fruit7', path:'images/item6.png'},
		{name:'fruit8', path:'images/item7.png'},
	];
	var imglist;
	var backLayer,playerLayer,fruitLayer;
	var fruitList = [];
	var score = 0;

	LInit(100,"legend",800,450,main);//初始化

	function main(){
		LLoadManage.load(imgData,null,gameInit);
		LGlobal.stage.addEventListener(LKeyboardEvent.KEY_DOWN, keydown);
		//LEvent.addEventListener(window,LKeyboardEvent.KEY_DOWN,keydown);
	}

	function gameInit(result){
		imglist = result;
		backLayer = new LSprite();
		addChild(backLayer);//添加背景层
		addBackGround();
		addPlayer();
		addFruit();
		var fruitTimer = new LTimer(2000, 0);
		fruitTimer.addEventListener(LTimerEvent.TIMER, addFruit);
		fruitTimer.start();
		var collapseTimer = new LTimer(1, 0);
		collapseTimer.addEventListener(LTimerEvent.TIMER, collapse);
		collapseTimer.start();
		addChild(new FPS());
		document.getElementById('score').innerHTML = "score: " + score;
	}

    //背景层
	function addBackGround(){
		var bitmap=new LBitmap(new LBitmapData(imglist["back"]));
		backLayer.addChild(bitmap);
	}

	function addFruit(){		
		fruitLayer = new LSprite();
		var randomFruit = 'fruit' + Math.ceil(Math.random()*8);
		var fruit = new LBitmap(new LBitmapData(imglist[randomFruit]));
		fruitList.push(fruit);
		// console.log(fruitList);
		fruit.x = Math.ceil(Math.random()*(800-fruit.getWidth()));
		var dropTimer = new LTimer(100, 0);
		dropTimer.addEventListener(LTimerEvent.TIMER, function(){
			fruit.y = fruit.y + 10;
		});
		dropTimer.start();
		fruitLayer.addChild(fruit);
		backLayer.addChild(fruitLayer);	
	}
	
	//人物层
	function addPlayer(){
		playerLayer = new LSprite();
		backLayer.addChild(playerLayer);		
		hero = new Player();		
	}

	//人物
	function Player(){
		base(this,LSprite,[]);//继承LSprite
		var list = LGlobal.divideCoordinate(256,256,4,4);
		var data = new LBitmapData(imglist["player"],0,-64,64,64);
		var bitmap = new LBitmap(data);
		player = new LAnimation(self,data,list);//利用一组精灵图标来制作动画
		player.x = player.y = 350;
		playerLayer.addEventListener(LEvent.ENTER_FRAME, onframe);
		player.addEventListener(LKeyboardEvent.KEY_DOWN, keydown);
		player.addEventListener(LKeyboardEvent.KEY_UP, keyup);
	}

	function keydown(e) {
		var speed = 10;
		trace("keydown e.keyCode = " + e.keyCode);
		if(e.keyCode == 65){
			if(player.x >= 0){
				// console.log(player.x);
				player.x = player.x - speed;
				player.setAction(1);
				// console.log(player.bitmap.bitmapData);
			}
		} else if(e.keyCode == 68){
			if(player.x <= (800-player.getWidth())){
				// console.log(player.x);
				player.x = player.x + speed;
				player.setAction(2);
			}
		}
	}

	function keyup(e){
		if(e.keyCode == 65){
			player.setAction(0);
		}else if(e.keyCode == 68){
			player.setAction(0);
		}
	}

	function checkCollapse(fruit, player){
		if(fruit.y+fruit.getHeight()<=player.y||fruit.x>=player.x+player.getWidth()||fruit.x+fruit.getWidth()<=player.x){
			return false;
		} else{
			return true;
		}

		return true;
	}

	function collapse(){
		fruitList.forEach(function(fruit, index){
			if(fruit.y>=450){
				fruit.remove();
				fruitList.splice(index, 1);
				score = score - 10;
				document.getElementById('score').innerHTML = "score: " + score;
			}else if(checkCollapse(fruit, player)){
				fruit.remove();
				fruitList.splice(index, 1);
				score = score + 10;
				document.getElementById('score').innerHTML = "score: " + score;
			}else{
				score = score;
			}
		})
	}

	function onframe(){
		player.onframe();
	}
</script> 
</html>